<!DOCTYPE html>
<html lang="en" data-theme="lofi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="version" content="1.0.0-web">
  <title>Non-QM Loan Advisor - Web</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/htmx.org@1.9.10/dist/htmx.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.css" rel="stylesheet" type="text/css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
  <style>
    .loading-dots::after {
      content: '';
      animation: dots 1.5s infinite;
    }
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60% { content: '...'; }
      80%, 100% { content: ''; }
    }
  </style>
</head>
<body class="bg-base-100">
  <!-- Database Integrity Overlay (hidden by default) -->
  <div id="integrityOverlay" class="hidden fixed inset-0 bg-base-100 bg-opacity-95 z-50 flex items-center justify-center">
    <div class="max-w-2xl mx-auto p-8">
      <div class="card bg-error text-error-content shadow-xl">
        <div class="card-body">
          <div class="flex items-center gap-4 mb-4">
            <span class="material-icons-outlined text-6xl">error</span>
            <div>
              <h2 class="card-title text-2xl">Database Error</h2>
              <p class="text-sm opacity-80">The application cannot start due to database issues</p>
            </div>
          </div>

          <div id="integrityErrors" class="space-y-2"></div>

          <div id="integrityWarnings" class="mt-4 hidden"></div>

          <div class="card-actions justify-end mt-6">
            <button class="btn btn-ghost" onclick="location.reload()">
              <span class="material-icons-outlined text-sm">refresh</span>
              Retry
            </button>
            <button class="btn btn-primary" onclick="showResetFromError()">
              <span class="material-icons-outlined text-sm">restart_alt</span>
              Reset Database
            </button>
          </div>
        </div>
      </div>

      <!-- Details Section -->
      <div id="integrityDetails" class="mt-4 collapse collapse-arrow bg-base-200">
        <input type="checkbox" />
        <div class="collapse-title text-sm font-medium">
          Show Technical Details
        </div>
        <div class="collapse-content">
          <pre id="integrityDetailsContent" class="text-xs overflow-auto"></pre>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Overlay (shown initially) -->
  <div id="loadingOverlay" class="fixed inset-0 bg-base-100 z-40 flex items-center justify-center">
    <div class="text-center">
      <span class="loading loading-spinner loading-lg"></span>
      <p class="mt-4 text-base-content/60">Checking database...</p>
    </div>
  </div>

  <!-- Header -->
  <div class="border-b border-base-300 px-6 py-4">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold">Non-QM Loan Advisor</h1>
        <p class="text-base-content/60">AI-powered loan program matching system</p>
      </div>
      <div class="space-x-2">
        <button class="btn btn-ghost btn-sm" onclick="clearBorrowerForm()">Clear</button>
        <button class="btn btn-outline btn-sm" onclick="loadSampleProfile()">Load Sample</button>
        <button class="btn btn-primary btn-sm" onclick="runLoanMatching()">Match</button>
        <button class="btn btn-secondary btn-sm" onclick="document.getElementById('uploadModal').showModal()">
          <span class="material-icons-outlined text-sm">upload_file</span>
          Upload Program
        </button>
        <div class="dropdown dropdown-end">
          <label tabindex="0" class="btn btn-ghost btn-sm">
            <span class="material-icons-outlined text-sm">settings</span>
            Database
          </label>
          <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
            <li><a onclick="showDatabaseInfo()">
              <span class="material-icons-outlined text-sm">info</span>
              Database Info
            </a></li>
            <li><a onclick="showBackupManager()">
              <span class="material-icons-outlined text-sm">backup</span>
              Manage Backups
            </a></li>
            <li class="menu-title"><span>Danger Zone</span></li>
            <li><a onclick="showResetConfirmation()" class="text-error">
              <span class="material-icons-outlined text-sm">restart_alt</span>
              Reset Database
            </a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="p-6">
    <!-- Borrower Filters -->
    <div class="mb-6">
      <h2 class="text-lg font-semibold mb-4">Borrower Profile</h2>

      <form id="borrowerForm" onsubmit="return false;">

        <!-- Primary Fields Row -->
        <div class="grid grid-cols-1 md:grid-cols-6 gap-3 mb-3">
          <div class="form-control">
            <label class="label label-text">Credit Score</label>
            <input type="number" name="creditScore" placeholder="680" min="300" max="850"
                   class="input input-bordered">
          </div>

          <div class="form-control">
            <label class="label label-text">Loan Amount</label>
            <input type="number" name="loanAmount" placeholder="500000" min="50000"
                   class="input input-bordered">
          </div>

          <div class="form-control">
            <label class="label label-text">LTV %</label>
            <input type="number" name="ltv" placeholder="75" min="1" max="100" step="0.1"
                   class="input input-bordered">
          </div>

          <div class="form-control">
            <label class="label label-text">DTI %</label>
            <input type="number" name="dti" placeholder="42" min="1" max="100" step="0.1"
                   class="input input-bordered">
          </div>

          <div class="form-control">
            <label class="label label-text">Transaction Type</label>
            <select name="transactionType" class="select select-bordered">
              <option value="">Select type</option>
              <option value="Purchase">Purchase</option>
              <option value="Rate & Term">Rate & Term</option>
              <option value="Cash Out">Cash Out</option>
            </select>
          </div>

          <div class="form-control">
            <label class="label label-text">Income Type</label>
            <select name="incomeType" class="select select-bordered">
              <option value="">Select documentation</option>
              <option value="2 years + YTD">2 years + YTD</option>
              <option value="1 year + YTD">1 year + YTD</option>
              <option value="No tax / income returns">No tax returns</option>
              <option value="1099s Only">1099s Only</option>
              <option value="P&L + 1 year tax returns">P&L + 1 year tax</option>
              <option value="No Ratio / Asset Qualifier">Asset Qualifier</option>
            </select>
          </div>
        </div>

        <!-- Secondary Fields Row -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4">
          <div class="form-control">
            <label class="label label-text">Reserves (Months)</label>
            <input type="number" name="reserves" placeholder="6" min="0" max="60"
                   class="input input-bordered">
          </div>

          <div class="form-control" id="cashOutField" style="display: none;">
            <label class="label label-text">Cash Out Amount</label>
            <input type="number" name="cashOutAmount" placeholder="50000" min="0"
                   class="input input-bordered">
          </div>

          <div class="form-control">
            <label class="label label-text">Occupancy</label>
            <select name="occupancy" class="select select-bordered">
              <option value="">Select occupancy</option>
              <option value="Owner Occupied">Owner Occupied</option>
              <option value="Second Home">Second Home</option>
              <option value="Investment">Investment</option>
            </select>
          </div>

          <div class="form-control">
            <label class="label label-text">Citizenship</label>
            <select name="citizenship" class="select select-bordered">
              <option value="">Select citizenship</option>
              <option value="US Citizen">US Citizen</option>
              <option value="Permanent Resident">Permanent Resident</option>
              <option value="Non-Permanent Resident">Non-Permanent Resident</option>
              <option value="Foreign National">Foreign National</option>
            </select>
          </div>
        </div>
      </form>
    </div>

    <!-- Bottom Section: 2-Column Layout for Query Interface and Results -->
    <div class="grid grid-cols-2 gap-6">
      <!-- Left Column: LoanPilot -->
      <div class="border border-base-300 rounded-lg">
        <div class="border-b border-base-300 p-4">
          <h2 class="text-lg font-semibold">LoanPilot</h2>
          <p class="text-xs text-base-content/60 mt-1">
            I can assist you in matching providers with borrower profiles
          </p>
        </div>

        <div class="p-4">
          <!-- Query History -->
          <div id="queryHistory" class="space-y-3 mb-4 overflow-y-auto" style="height: 300px; min-height: 300px; max-height: 300px;">
            <div class="alert alert-info text-xs">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <div>
                <div class="font-semibold">Query Examples:</div>
                <ul class="list-disc list-inside mt-1 text-xs">
                  <li>find all parameters for PRMG/Prime Connect</li>
                  <li>show borrower_credit_score in Prime programs</li>
                  <li>match programs for 680 credit score</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- Query Input -->
          <div class="border-t border-base-300 pt-4" style="min-height: 180px;">
            <form id="queryForm"
                  hx-post="/api/query/execute"
                  hx-target="#queryHistory"
                  hx-swap="beforeend"
                  hx-indicator="#queryLoader"
                  class="space-y-2">

              <div class="flex gap-2">
                <input type="text"
                       name="query"
                       placeholder="your query here..."
                       class="input input-bordered flex-1 font-mono text-sm"
                       required>
                <button type="submit" class="btn btn-primary">Execute</button>
              </div>

              <!-- Quick Query Templates -->
              <div class="flex gap-1 flex-wrap">
                <button type="button" class="btn btn-xs btn-ghost"
                        onclick="document.querySelector('[name=query]').value='find all parameters for PRMG/Prime Connect'">
                  Find Params
                </button>
                <button type="button" class="btn btn-xs btn-ghost"
                        onclick="document.querySelector('[name=query]').value='show programs in Prime'">
                  List Programs
                </button>
                <button type="button" class="btn btn-xs btn-ghost"
                        onclick="clearQueryHistory()">
                  Clear History
                </button>
                <button type="button" class="btn btn-xs btn-ghost"
                        hx-get="/api/query/scripts"
                        hx-target="#queryHistory"
                        hx-swap="innerHTML">
                  Available Scripts
                </button>
              </div>
            </form>

            <!-- Query Loading Indicator -->
            <div id="queryLoader" class="htmx-indicator mt-2">
              <div class="flex items-center justify-center">
                <span class="loading loading-dots loading-sm"></span>
                <span class="ml-2 text-sm">Executing query...</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column: Results Panel -->
      <div class="border border-base-300 rounded-lg">
        <div class="border-b border-base-300 p-4">
          <div class="flex justify-between items-center">
            <h2 id="resultsHeader" class="text-lg font-semibold">Loan Program Results</h2>
            <div class="tooltip tooltip-left" data-tip="Click programs to select them. Selected programs provide context for queries. Press ESC to clear selection.">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-base-content/40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
          </div>
        </div>
        <div class="p-4">
          <div id="resultsContent" class="space-y-4">
            <div class="text-center text-base-content/60 py-8">
              <p>Enter borrower information and click "Find Matching Programs" to see eligible loan options.</p>
              <p class="text-xs mt-2 text-base-content/40">üí° Tip: Click program cards to select them for context-aware queries</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // VERSION: 1.0.0-WEB (No Electron, pure browser)
    console.log('üîÑ LoanPilot Web - Version 1.0.0');

    // Program selection state (replaces Electron preload functions)
    const selectedPrograms = new Set();

    // App functions (browser-native implementation)
    const appFunctions = {
      toggleProgramSelection(programName, servicer) {
        const programKey = `${servicer}::${programName}`;
        const card = document.querySelector(`[data-program-key="${programKey}"]`);

        if (!card) return;

        const checkbox = card.querySelector('input[type="checkbox"]');

        if (selectedPrograms.has(programKey)) {
          selectedPrograms.delete(programKey);
          card.classList.remove('ring-2', 'ring-primary');
          if (checkbox) checkbox.checked = false;
        } else {
          selectedPrograms.add(programKey);
          card.classList.add('ring-2', 'ring-primary');
          if (checkbox) checkbox.checked = true;
        }

        this.updateSelectionIndicator();
      },

      updateSelectionIndicator() {
        const header = document.getElementById('resultsHeader');
        const count = selectedPrograms.size;

        if (count > 0) {
          const baseText = header.textContent.replace(/\s*\(\d+ selected\)/, '');
          header.textContent = `${baseText} (${count} selected)`;
        } else {
          header.textContent = header.textContent.replace(/\s*\(\d+ selected\)/, '');
        }
      },

      clearProgramSelection() {
        selectedPrograms.clear();
        document.querySelectorAll('[data-program-key]').forEach(card => {
          card.classList.remove('ring-2', 'ring-primary');
          const checkbox = card.querySelector('input[type="checkbox"]');
          if (checkbox) checkbox.checked = false;
        });
        this.updateSelectionIndicator();
      },

      getSelectedPrograms() {
        const programs = [];
        selectedPrograms.forEach(key => {
          const [servicer, ...nameParts] = key.split('::');
          programs.push({
            servicer: servicer,
            programName: nameParts.join('::')
          });
        });
        return programs;
      },

      clearBorrowerForm() {
        document.getElementById('borrowerForm').reset();
      },

      loadSampleProfile() {
        // Clear all previous program selections and results
        this.clearProgramSelection();

        // Clear results panel
        document.getElementById('resultsContent').innerHTML = `
          <div class="text-center text-base-content/60 py-8">
            <p>Enter borrower information and click "Find Matching Programs" to see eligible loan options.</p>
            <p class="text-xs mt-2 text-base-content/40">üí° Tip: Click program cards to select them for context-aware queries</p>
          </div>
        `;

        // Reset results header
        document.getElementById('resultsHeader').textContent = 'Loan Program Results';

        // Array of diverse sample profiles
        const sampleProfiles = [
          {
            creditScore: '680',
            loanAmount: '500000',
            ltv: '75',
            dti: '42',
            transactionType: 'Purchase',
            occupancy: 'Owner Occupied'
          },
          {
            creditScore: '720',
            loanAmount: '750000',
            ltv: '80',
            dti: '38',
            transactionType: 'Rate & Term',
            occupancy: 'Owner Occupied'
          },
          {
            creditScore: '640',
            loanAmount: '350000',
            ltv: '70',
            dti: '45',
            transactionType: 'Purchase',
            occupancy: 'Investment'
          },
          {
            creditScore: '760',
            loanAmount: '1000000',
            ltv: '85',
            dti: '35',
            transactionType: 'Cash Out',
            occupancy: 'Owner Occupied'
          },
          {
            creditScore: '700',
            loanAmount: '600000',
            ltv: '78',
            dti: '40',
            transactionType: 'Purchase',
            occupancy: 'Second Home'
          },
          {
            creditScore: '620',
            loanAmount: '425000',
            ltv: '72',
            dti: '48',
            transactionType: 'Rate & Term',
            occupancy: 'Owner Occupied'
          }
        ];

        // Randomly select a profile
        const randomProfile = sampleProfiles[Math.floor(Math.random() * sampleProfiles.length)];

        // Populate form with selected profile
        const form = document.getElementById('borrowerForm');
        form.creditScore.value = randomProfile.creditScore;
        form.loanAmount.value = randomProfile.loanAmount;
        form.ltv.value = randomProfile.ltv;
        form.dti.value = randomProfile.dti;
        form.transactionType.value = randomProfile.transactionType;
        form.occupancy.value = randomProfile.occupancy;

        // Trigger transaction type change event if Cash Out
        if (randomProfile.transactionType === 'Cash Out') {
          form.transactionType.dispatchEvent(new Event('change'));
        }
      },

      runLoanMatching() {
        const form = document.getElementById('borrowerForm');
        const query = `match programs for ${form.creditScore.value} credit score, $${form.loanAmount.value} loan amount, ${form.ltv.value}% LTV, ${form.dti.value}% DTI, ${form.transactionType.value}, ${form.occupancy.value}`;

        fetch('/api/query/execute', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'HX-Request': 'true'
          },
          body: new URLSearchParams({ query })
        })
        .then(r => r.text())
        .then(html => {
          const div = document.createElement('div');
          div.innerHTML = html;
          const oob = div.querySelectorAll('[hx-swap-oob]');

          oob.forEach((el) => {
            const attr = el.getAttribute('hx-swap-oob');
            const parts = attr.split(':');
            if (parts.length === 2 && parts[1].startsWith('#')) {
              const target = document.querySelector(parts[1]);
              if (target) {
                target.innerHTML = el.innerHTML;
              }
            }
          });
        });
      },

      clearQueryHistory() {
        document.getElementById('queryHistory').innerHTML = `
          <div class="alert alert-info text-xs">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <div>
              <div class="font-semibold">Query Examples:</div>
              <ul class="list-disc list-inside mt-1 text-xs">
                <li>find all parameters for PRMG/Prime Connect</li>
                <li>show borrower_credit_score in Prime programs</li>
                <li>match programs for 680 credit score</li>
              </ul>
            </div>
          </div>
        `;
      }
    };

    // Make appFunctions globally available (for onclick handlers)
    window.appFunctions = appFunctions;

    // Convenience functions for onclick handlers
    window.toggleProgramSelection = appFunctions.toggleProgramSelection.bind(appFunctions);
    window.clearBorrowerForm = appFunctions.clearBorrowerForm.bind(appFunctions);
    window.loadSampleProfile = appFunctions.loadSampleProfile.bind(appFunctions);
    window.runLoanMatching = appFunctions.runLoanMatching.bind(appFunctions);
    window.clearQueryHistory = appFunctions.clearQueryHistory.bind(appFunctions);

    // ESC key handler to clear program selection
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const selectedProgramsArray = appFunctions.getSelectedPrograms();
        if (selectedProgramsArray.length > 0) {
          appFunctions.clearProgramSelection();

          // Show visual feedback
          const header = document.getElementById('resultsHeader');
          if (header) {
            const originalText = header.textContent;
            header.textContent = 'Selection Cleared';
            header.classList.add('text-warning');

            setTimeout(() => {
              header.textContent = originalText.replace(/\d+ selected/, '').trim();
              header.classList.remove('text-warning');
            }, 1000);
          }
        }
      }
    });

    // Show/hide cash out amount field based on transaction type
    document.querySelector('select[name="transactionType"]').addEventListener('change', function(e) {
      const cashOutField = document.getElementById('cashOutField');
      if (e.target.value === 'Cash Out') {
        cashOutField.style.display = 'block';
      } else {
        cashOutField.style.display = 'none';
        cashOutField.querySelector('input').value = '';
      }
    });

    // Auto-scroll query history
    document.body.addEventListener('htmx:afterSettle', function(evt) {
      if (evt.detail.target.id === 'queryHistory') {
        const queryHistory = evt.detail.target;
        requestAnimationFrame(() => {
          queryHistory.scrollTop = queryHistory.scrollHeight;
        });
      }
    });

    // Intercept query form submission to add program context
    document.getElementById('queryForm').addEventListener('htmx:configRequest', function(evt) {
      const selectedProgramsArray = appFunctions.getSelectedPrograms();

      if (selectedProgramsArray.length > 0) {
        const programContext = selectedProgramsArray.map(p => p.programName).join(', ');
        evt.detail.parameters.selectedPrograms = JSON.stringify(selectedProgramsArray);
        evt.detail.parameters.programContext = programContext;

        console.log('Query with program context:', programContext);
      }
    });

    // Clear query form after submission
    document.getElementById('queryForm').addEventListener('htmx:afterRequest', function(evt) {
      if (evt.detail.successful) {
        document.querySelector('[name=query]').value = '';
      }
    });

    // Show parameter detail popup
    window.showParamDetail = function(programName, paramType) {
      const modal = document.getElementById('paramDetailModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalContent = document.getElementById('modalContent');

      // Set title
      const titleMap = {
        'occupancy': 'Occupancy Requirements',
        'transaction': 'Transaction Type',
        'reserves': 'Reserve Requirements',
        'documentation': 'Documentation Requirements',
        'citizenship': 'Citizenship Requirements'
      };
      modalTitle.textContent = titleMap[paramType] || 'Parameter Details';

      // Show loading state
      modalContent.innerHTML = '<div class="flex items-center justify-center py-4"><span class="loading loading-spinner loading-md"></span></div>';
      modal.checked = true;

      // Fetch actual data from API
      const servicer = programName.includes('LoanStream') ? 'LoanStream' : 'Prime';
      fetch(`/api/program/parameter?programName=${encodeURIComponent(programName)}&servicer=${encodeURIComponent(servicer)}&paramType=${paramType}`)
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            modalContent.innerHTML = `
              <div class="space-y-3">
                <div class="text-sm">
                  <strong class="text-base-content/60">Program:</strong>
                  <span class="font-semibold">${programName}</span>
                </div>
                <div class="divider my-2"></div>
                <div class="text-sm whitespace-pre-wrap leading-relaxed">${data.value}</div>
              </div>
            `;
          } else {
            modalContent.innerHTML = `
              <div class="alert alert-error">
                <span>Error loading data: ${data.error || 'Unknown error'}</span>
              </div>
            `;
          }
        })
        .catch(err => {
          modalContent.innerHTML = `
            <div class="alert alert-error">
              <span>Failed to fetch data: ${err.message}</span>
            </div>
          `;
        });
    };
  </script>

  <!-- Modal for Parameter Details -->
  <input type="checkbox" id="paramDetailModal" class="modal-toggle" />
  <div class="modal">
    <div class="modal-box">
      <h3 id="modalTitle" class="font-bold text-lg mb-4"></h3>
      <div id="modalContent" class="py-4"></div>
      <div class="modal-action">
        <label for="paramDetailModal" class="btn btn-sm">Close</label>
      </div>
    </div>
    <label class="modal-backdrop" for="paramDetailModal"></label>
  </div>

  <!-- Program Upload Modal -->
  <dialog id="uploadModal" class="modal">
    <div class="modal-box w-11/12 max-w-2xl">
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">‚úï</button>
      </form>

      <h3 class="font-bold text-lg mb-4">Upload New Loan Program</h3>

      <div class="space-y-4">
        <!-- Instructions -->
        <div class="alert alert-info">
          <span class="material-icons-outlined">info</span>
          <div class="text-sm">
            <p><strong>Upload a TSV file</strong> containing exactly one new program column with 60 attribute rows.</p>
            <p class="mt-1">The file must match the existing attribute structure (Attribute Group, Attribute Name, Values, Borrower Facing).</p>
          </div>
        </div>

        <!-- File Upload -->
        <div class="form-control w-full">
          <label class="label">
            <span class="label-text">Select TSV File</span>
          </label>
          <input type="file"
                 id="tsvFile"
                 accept=".tsv,.txt"
                 class="file-input file-input-bordered w-full"
                 onchange="handleFileSelect(event)" />
          <label class="label">
            <span class="label-text-alt">Accepted formats: .tsv, .txt</span>
          </label>
        </div>

        <!-- Validation Results -->
        <div id="validationResults" class="hidden">
          <!-- Success -->
          <div id="validationSuccess" class="alert alert-success hidden">
            <span class="material-icons-outlined">check_circle</span>
            <div class="text-sm">
              <p><strong>Validation Passed!</strong></p>
              <p id="validationSummary" class="mt-1"></p>
            </div>
          </div>

          <!-- Errors -->
          <div id="validationErrors" class="alert alert-error hidden">
            <span class="material-icons-outlined">error</span>
            <div class="text-sm">
              <p><strong>Validation Failed</strong></p>
              <ul id="errorList" class="list-disc list-inside mt-1"></ul>
            </div>
          </div>

          <!-- Warnings -->
          <div id="validationWarnings" class="alert alert-warning hidden">
            <span class="material-icons-outlined">warning</span>
            <div class="text-sm">
              <p><strong>Warnings</strong></p>
              <ul id="warningList" class="list-disc list-inside mt-1"></ul>
            </div>
          </div>
        </div>

        <!-- Import Controls -->
        <div id="importControls" class="hidden">
          <div class="form-control">
            <label class="label">
              <span class="label-text">Program Name</span>
            </label>
            <input type="text"
                   id="programName"
                   class="input input-bordered w-full"
                   readonly />
          </div>

          <div class="form-control mt-3">
            <label class="label">
              <span class="label-text">Servicer</span>
            </label>
            <input type="text"
                   id="servicerName"
                   class="input input-bordered w-full"
                   readonly />
          </div>
        </div>

        <!-- Import Status -->
        <div id="importStatus" class="hidden"></div>

        <!-- Actions -->
        <div class="modal-action">
          <button type="button"
                  class="btn btn-ghost"
                  onclick="closeUploadModal()">
            Cancel
          </button>
          <button type="button"
                  id="importBtn"
                  class="btn btn-primary hidden"
                  onclick="importProgram()">
            <span class="material-icons-outlined text-sm">upload</span>
            Import Program
          </button>
        </div>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <!-- Database Info Modal -->
  <dialog id="databaseInfoModal" class="modal">
    <div class="modal-box">
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">‚úï</button>
      </form>

      <h3 class="font-bold text-lg mb-4">Database Information</h3>

      <div id="databaseInfoContent" class="space-y-3">
        <div class="flex items-center justify-center py-4">
          <span class="loading loading-spinner loading-md"></span>
        </div>
      </div>

      <div class="modal-action">
        <button type="button" class="btn btn-sm" onclick="document.getElementById('databaseInfoModal').close()">Close</button>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <!-- Backup Manager Modal -->
  <dialog id="backupManagerModal" class="modal">
    <div class="modal-box w-11/12 max-w-2xl">
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">‚úï</button>
      </form>

      <h3 class="font-bold text-lg mb-4">Backup Manager</h3>

      <div class="space-y-4">
        <!-- Create Backup Section -->
        <div class="card bg-base-200">
          <div class="card-body p-4">
            <h4 class="card-title text-md">Create New Backup</h4>
            <p class="text-sm text-base-content/70">Create a timestamped backup of the current database</p>
            <div class="card-actions justify-end mt-2">
              <button class="btn btn-primary btn-sm" onclick="createBackup()">
                <span class="material-icons-outlined text-sm">backup</span>
                Create Backup
              </button>
            </div>
          </div>
        </div>

        <!-- Backup List -->
        <div>
          <h4 class="font-semibold mb-2">Available Backups</h4>
          <div id="backupsList" class="space-y-2">
            <div class="flex items-center justify-center py-4">
              <span class="loading loading-spinner loading-md"></span>
            </div>
          </div>
        </div>

        <div id="backupStatus" class="hidden"></div>
      </div>

      <div class="modal-action">
        <button type="button" class="btn btn-sm" onclick="document.getElementById('backupManagerModal').close()">Close</button>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <!-- Reset Confirmation Modal -->
  <dialog id="resetConfirmModal" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-4 text-error">‚ö†Ô∏è Reset Database</h3>

      <div class="space-y-4">
        <div class="alert alert-warning">
          <span class="material-icons-outlined">warning</span>
          <div class="text-sm">
            <p><strong>This action will:</strong></p>
            <ul class="list-disc list-inside mt-2">
              <li>Drop all database tables</li>
              <li>Delete all uploaded programs</li>
              <li>Repopulate with original data from TSV</li>
            </ul>
            <p class="mt-2">A backup will be created automatically before resetting.</p>
          </div>
        </div>

        <div class="form-control">
          <label class="label cursor-pointer">
            <span class="label-text">Create backup before reset</span>
            <input type="checkbox" id="createBackupCheck" class="checkbox checkbox-primary" checked />
          </label>
        </div>

        <div id="resetStatus" class="hidden"></div>
      </div>

      <div class="modal-action">
        <button type="button" class="btn btn-ghost btn-sm" onclick="document.getElementById('resetConfirmModal').close()">Cancel</button>
        <button type="button" id="confirmResetBtn" class="btn btn-error btn-sm" onclick="confirmReset()">
          <span class="material-icons-outlined text-sm">restart_alt</span>
          Reset Database
        </button>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <script>
    // ========== Database Integrity Check (runs on page load) ==========

    let databaseIsValid = false;

    async function checkDatabaseIntegrity() {
      try {
        const response = await fetch('/api/database/integrity');
        const data = await response.json();

        if (data.success && data.integrity.is_valid) {
          // Database is valid - hide loading, show app
          databaseIsValid = true;
          document.getElementById('loadingOverlay').classList.add('hidden');
          console.log('‚úÖ Database integrity check passed');
          return true;
        } else {
          // Database has errors - show error overlay
          databaseIsValid = false;
          showIntegrityError(data.integrity);
          return false;
        }
      } catch (error) {
        console.error('Failed to check database integrity:', error);
        databaseIsValid = false;
        showIntegrityError({
          is_valid: false,
          errors: ['Failed to connect to server: ' + error.message],
          warnings: [],
          details: {}
        });
        return false;
      }
    }

    function showIntegrityError(integrity) {
      // Hide loading overlay
      document.getElementById('loadingOverlay').classList.add('hidden');

      // Show error overlay
      document.getElementById('integrityOverlay').classList.remove('hidden');

      // Display errors
      const errorsDiv = document.getElementById('integrityErrors');
      if (integrity.errors && integrity.errors.length > 0) {
        errorsDiv.innerHTML = `
          <div class="alert alert-error bg-error-content text-error">
            <div class="flex flex-col gap-2 w-full">
              <p class="font-bold">Critical Errors:</p>
              <ul class="list-disc list-inside">
                ${integrity.errors.map(err => `<li class="text-sm">${err}</li>`).join('')}
              </ul>
            </div>
          </div>
        `;
      }

      // Display warnings (if any)
      const warningsDiv = document.getElementById('integrityWarnings');
      if (integrity.warnings && integrity.warnings.length > 0) {
        warningsDiv.classList.remove('hidden');
        warningsDiv.innerHTML = `
          <div class="alert alert-warning bg-warning-content text-warning">
            <div class="flex flex-col gap-2 w-full">
              <p class="font-bold">Warnings:</p>
              <ul class="list-disc list-inside">
                ${integrity.warnings.map(warn => `<li class="text-sm">${warn}</li>`).join('')}
              </ul>
            </div>
          </div>
        `;
      }

      // Display technical details
      document.getElementById('integrityDetailsContent').textContent =
        JSON.stringify(integrity.details, null, 2);

      // Disable all form controls on the page
      disableAllControls();

      console.error('‚ùå Database integrity check failed:', integrity.errors);
    }

    function disableAllControls() {
      // Disable all buttons except those in the error overlay
      const buttons = document.querySelectorAll('button:not(#integrityOverlay button):not(#integrityDetails button)');
      buttons.forEach(btn => {
        btn.disabled = true;
        btn.classList.add('btn-disabled');
      });

      // Disable all inputs
      const inputs = document.querySelectorAll('input:not(#integrityOverlay input), select, textarea');
      inputs.forEach(input => {
        input.disabled = true;
      });

      // Add overlay to main content
      const mainContent = document.querySelector('body > div:not(#integrityOverlay):not(#loadingOverlay)');
      if (mainContent) {
        mainContent.style.opacity = '0.5';
        mainContent.style.pointerEvents = 'none';
      }
    }

    function showResetFromError() {
      // Hide error overlay
      document.getElementById('integrityOverlay').classList.add('hidden');

      // Show reset modal
      showResetConfirmation();
    }

    // Run integrity check on page load
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üîç Running database integrity check...');
      checkDatabaseIntegrity();
    });

    // ========== Database Management Functions ==========

    async function showDatabaseInfo() {
      const modal = document.getElementById('databaseInfoModal');
      const content = document.getElementById('databaseInfoContent');

      modal.showModal();

      // Show loading
      content.innerHTML = '<div class="flex items-center justify-center py-4"><span class="loading loading-spinner loading-md"></span></div>';

      try {
        const response = await fetch('/api/database/info');
        const data = await response.json();

        if (data.success) {
          const db = data.database;
          content.innerHTML = `
            <div class="stats stats-vertical shadow w-full">
              <div class="stat">
                <div class="stat-title">Database Size</div>
                <div class="stat-value text-2xl">${db.size_kb} KB</div>
              </div>

              <div class="stat">
                <div class="stat-title">Total Tables</div>
                <div class="stat-value text-2xl">${db.total_tables}</div>
              </div>

              <div class="stat">
                <div class="stat-title">Total Programs</div>
                <div class="stat-value text-2xl">${db.total_programs || 0}</div>
                <div class="stat-desc">Prime: ${db.program_counts?.Prime || 0} | LoanStream: ${db.program_counts?.LoanStream || 0}</div>
              </div>
            </div>

            <div class="mt-4">
              <h4 class="font-semibold mb-2">Tables</h4>
              <div class="overflow-x-auto">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Table Name</th>
                      <th>Rows</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${Object.entries(db.tables || {}).map(([name, count]) => `
                      <tr>
                        <td>${name}</td>
                        <td>${count}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          `;
        } else {
          content.innerHTML = `
            <div class="alert alert-error">
              <span>Error: ${data.error || 'Failed to load database info'}</span>
            </div>
          `;
        }
      } catch (error) {
        content.innerHTML = `
          <div class="alert alert-error">
            <span>Failed to fetch database info: ${error.message}</span>
          </div>
        `;
      }
    }

    async function showBackupManager() {
      const modal = document.getElementById('backupManagerModal');
      modal.showModal();
      await loadBackupsList();
    }

    async function loadBackupsList() {
      const listDiv = document.getElementById('backupsList');

      // Show loading
      listDiv.innerHTML = '<div class="flex items-center justify-center py-4"><span class="loading loading-spinner loading-md"></span></div>';

      try {
        const response = await fetch('/api/database/backups');
        const data = await response.json();

        if (data.success && data.backups.length > 0) {
          listDiv.innerHTML = data.backups.map(backup => `
            <div class="card bg-base-200">
              <div class="card-body p-3">
                <div class="flex justify-between items-center">
                  <div class="flex-1">
                    <div class="font-mono text-sm">${backup.name}</div>
                    <div class="text-xs text-base-content/60">${backup.size_kb} KB ‚Ä¢ ${new Date(backup.created).toLocaleString()}</div>
                  </div>
                  <button class="btn btn-ghost btn-xs" onclick="restoreBackup('${backup.name}')">
                    <span class="material-icons-outlined text-sm">restore</span>
                    Restore
                  </button>
                </div>
              </div>
            </div>
          `).join('');
        } else if (data.success && data.backups.length === 0) {
          listDiv.innerHTML = '<div class="text-sm text-base-content/60 text-center py-4">No backups found</div>';
        } else {
          listDiv.innerHTML = `
            <div class="alert alert-error">
              <span>Error: ${data.error || 'Failed to load backups'}</span>
            </div>
          `;
        }
      } catch (error) {
        listDiv.innerHTML = `
          <div class="alert alert-error">
            <span>Failed to fetch backups: ${error.message}</span>
          </div>
        `;
      }
    }

    async function createBackup() {
      const statusDiv = document.getElementById('backupStatus');
      statusDiv.classList.remove('hidden');
      statusDiv.innerHTML = '<div class="flex items-center justify-center py-2"><span class="loading loading-spinner loading-sm"></span><span class="ml-2">Creating backup...</span></div>';

      try {
        const response = await fetch('/api/database/backup', {
          method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
          statusDiv.innerHTML = `
            <div class="alert alert-success">
              <span class="material-icons-outlined">check_circle</span>
              <span>Backup created: ${data.backup_name} (${data.size_kb} KB)</span>
            </div>
          `;

          // Reload backups list
          setTimeout(() => {
            loadBackupsList();
            setTimeout(() => statusDiv.classList.add('hidden'), 2000);
          }, 1000);

        } else {
          statusDiv.innerHTML = `
            <div class="alert alert-error">
              <span class="material-icons-outlined">error</span>
              <span>Backup failed: ${data.error}</span>
            </div>
          `;
        }
      } catch (error) {
        statusDiv.innerHTML = `
          <div class="alert alert-error">
            <span>Failed to create backup: ${error.message}</span>
          </div>
        `;
      }
    }

    async function restoreBackup(backupName) {
      if (!confirm(`Restore database from backup "${backupName}"?\n\nThis will replace the current database. A backup of the current state will be created first.`)) {
        return;
      }

      const statusDiv = document.getElementById('backupStatus');
      statusDiv.classList.remove('hidden');
      statusDiv.innerHTML = '<div class="flex items-center justify-center py-2"><span class="loading loading-spinner loading-sm"></span><span class="ml-2">Restoring database...</span></div>';

      try {
        const formData = new FormData();
        formData.append('backup_name', backupName);

        const response = await fetch('/api/database/restore', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.success) {
          statusDiv.innerHTML = `
            <div class="alert alert-success">
              <span class="material-icons-outlined">check_circle</span>
              <div>
                <p>${data.message}</p>
                <p class="text-xs mt-1">Current database backed up as: ${data.current_backup}</p>
              </div>
            </div>
          `;

          // Reload page after 2 seconds
          setTimeout(() => {
            window.location.reload();
          }, 2000);

        } else {
          statusDiv.innerHTML = `
            <div class="alert alert-error">
              <span class="material-icons-outlined">error</span>
              <span>Restore failed: ${data.error}</span>
            </div>
          `;
        }
      } catch (error) {
        statusDiv.innerHTML = `
          <div class="alert alert-error">
            <span>Failed to restore: ${error.message}</span>
          </div>
        `;
      }
    }

    function showResetConfirmation() {
      document.getElementById('resetConfirmModal').showModal();
      document.getElementById('resetStatus').classList.add('hidden');
      document.getElementById('confirmResetBtn').disabled = false;
    }

    async function confirmReset() {
      const createBackup = document.getElementById('createBackupCheck').checked;
      const confirmBtn = document.getElementById('confirmResetBtn');
      const statusDiv = document.getElementById('resetStatus');

      // Disable button
      confirmBtn.disabled = true;
      confirmBtn.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Resetting...';

      statusDiv.classList.remove('hidden');
      statusDiv.innerHTML = '<div class="flex items-center justify-center py-2"><span class="loading loading-spinner loading-md"></span><span class="ml-2">Resetting database...</span></div>';

      try {
        const formData = new FormData();
        formData.append('create_backup', createBackup);

        const response = await fetch('/api/database/reset', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.success) {
          const backupInfo = data.steps.find(s => s.step === 'backup');
          const repopulateInfo = data.steps.find(s => s.step === 'repopulate');

          statusDiv.innerHTML = `
            <div class="alert alert-success">
              <span class="material-icons-outlined">check_circle</span>
              <div>
                <p><strong>Database Reset Complete!</strong></p>
                ${backupInfo?.success ? `<p class="text-xs mt-1">Backup: ${backupInfo.data.backup_name}</p>` : ''}
                ${repopulateInfo?.success ? `<p class="text-xs">Repopulated: ${repopulateInfo.data.prime_programs} Prime + ${repopulateInfo.data.loanstream_programs} LoanStream programs</p>` : ''}
              </div>
            </div>
          `;

          // Reload page after 2 seconds
          setTimeout(() => {
            window.location.reload();
          }, 2000);

        } else {
          statusDiv.innerHTML = `
            <div class="alert alert-error">
              <span class="material-icons-outlined">error</span>
              <span>Reset failed: ${data.error || 'Unknown error'}</span>
            </div>
          `;

          // Re-enable button
          confirmBtn.disabled = false;
          confirmBtn.innerHTML = '<span class="material-icons-outlined text-sm">restart_alt</span> Reset Database';
        }
      } catch (error) {
        statusDiv.innerHTML = `
          <div class="alert alert-error">
            <span>Failed to reset database: ${error.message}</span>
          </div>
        `;

        // Re-enable button
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = '<span class="material-icons-outlined text-sm">restart_alt</span> Reset Database';
      }
    }

    // ========== Upload Modal Functions ==========

    // Upload Modal Functions
    let currentFileContent = null;
    let currentValidation = null;

    async function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Reset UI
      document.getElementById('validationResults').classList.add('hidden');
      document.getElementById('importControls').classList.add('hidden');
      document.getElementById('importBtn').classList.add('hidden');
      document.getElementById('importStatus').classList.add('hidden');

      // Show loading
      const resultsDiv = document.getElementById('validationResults');
      resultsDiv.classList.remove('hidden');
      resultsDiv.innerHTML = '<div class="flex items-center justify-center py-4"><span class="loading loading-spinner loading-md"></span><span class="ml-2">Validating...</span></div>';

      try {
        // Create form data
        const formData = new FormData();
        formData.append('file', file);

        // Validate file
        const response = await fetch('/api/programs/validate', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Validation request failed');
        }

        currentValidation = data.validation;
        currentFileContent = file;

        displayValidationResults(data.validation);

      } catch (error) {
        console.error('Validation error:', error);
        resultsDiv.innerHTML = `
          <div class="alert alert-error">
            <span class="material-icons-outlined">error</span>
            <span>Failed to validate file: ${error.message}</span>
          </div>
        `;
      }
    }

    function displayValidationResults(validation) {
      const resultsDiv = document.getElementById('validationResults');
      const successDiv = document.getElementById('validationSuccess');
      const errorsDiv = document.getElementById('validationErrors');
      const warningsDiv = document.getElementById('validationWarnings');
      const importControls = document.getElementById('importControls');
      const importBtn = document.getElementById('importBtn');

      // Clear previous results
      resultsDiv.innerHTML = '';
      resultsDiv.classList.add('hidden');
      successDiv.classList.add('hidden');
      errorsDiv.classList.add('hidden');
      warningsDiv.classList.add('hidden');
      importControls.classList.add('hidden');
      importBtn.classList.add('hidden');

      // Show validation results
      resultsDiv.classList.remove('hidden');
      resultsDiv.appendChild(successDiv);
      resultsDiv.appendChild(errorsDiv);
      resultsDiv.appendChild(warningsDiv);

      if (validation.is_valid) {
        // Show success
        successDiv.classList.remove('hidden');
        document.getElementById('validationSummary').textContent =
          `Program: ${validation.program_name} | Servicer: ${validation.servicer} | Rows: ${validation.row_count} | Attributes Matched: ${validation.attributes_matched}/60`;

        // Show import controls
        importControls.classList.remove('hidden');
        document.getElementById('programName').value = validation.program_name;
        document.getElementById('servicerName').value = validation.servicer;

        // Show import button
        importBtn.classList.remove('hidden');

        // Show warnings if any
        if (validation.warnings && validation.warnings.length > 0) {
          warningsDiv.classList.remove('hidden');
          const warningList = document.getElementById('warningList');
          warningList.innerHTML = validation.warnings.map(w => `<li>${w}</li>`).join('');
        }
      } else {
        // Show errors
        errorsDiv.classList.remove('hidden');
        const errorList = document.getElementById('errorList');
        errorList.innerHTML = validation.errors.map(e => `<li>${e}</li>`).join('');
      }
    }

    async function importProgram() {
      if (!currentFileContent || !currentValidation || !currentValidation.is_valid) {
        alert('Please validate a file first');
        return;
      }

      const importBtn = document.getElementById('importBtn');
      const statusDiv = document.getElementById('importStatus');

      // Disable button and show loading
      importBtn.disabled = true;
      importBtn.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Importing...';

      statusDiv.classList.remove('hidden');
      statusDiv.innerHTML = '<div class="flex items-center justify-center py-2"><span class="loading loading-spinner loading-md"></span><span class="ml-2">Importing program into database...</span></div>';

      try {
        // Create form data
        const formData = new FormData();
        formData.append('file', currentFileContent);
        formData.append('program_name', currentValidation.program_name);
        formData.append('servicer', currentValidation.servicer);

        // Import file
        const response = await fetch('/api/programs/import', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.success) {
          statusDiv.innerHTML = `
            <div class="alert alert-success">
              <span class="material-icons-outlined">check_circle</span>
              <div>
                <p><strong>Import Successful!</strong></p>
                <p class="text-sm mt-1">${data.message}</p>
                <p class="text-xs mt-1">Rows updated: ${data.rows_updated}</p>
              </div>
            </div>
          `;

          // Hide import button
          importBtn.classList.add('hidden');

          // Auto-close after 2 seconds
          setTimeout(() => {
            closeUploadModal();
            // Reload page to show new program
            window.location.reload();
          }, 2000);

        } else {
          statusDiv.innerHTML = `
            <div class="alert alert-error">
              <span class="material-icons-outlined">error</span>
              <span>${data.error || 'Import failed'}</span>
            </div>
          `;

          // Re-enable button
          importBtn.disabled = false;
          importBtn.innerHTML = '<span class="material-icons-outlined text-sm">upload</span> Import Program';
        }

      } catch (error) {
        console.error('Import error:', error);
        statusDiv.innerHTML = `
          <div class="alert alert-error">
            <span class="material-icons-outlined">error</span>
            <span>Failed to import: ${error.message}</span>
          </div>
        `;

        // Re-enable button
        importBtn.disabled = false;
        importBtn.innerHTML = '<span class="material-icons-outlined text-sm">upload</span> Import Program';
      }
    }

    function closeUploadModal() {
      document.getElementById('uploadModal').close();

      // Reset form after closing
      setTimeout(() => {
        document.getElementById('tsvFile').value = '';
        document.getElementById('validationResults').classList.add('hidden');
        document.getElementById('importControls').classList.add('hidden');
        document.getElementById('importBtn').classList.add('hidden');
        document.getElementById('importStatus').classList.add('hidden');
        currentFileContent = null;
        currentValidation = null;
      }, 300);
    }
  </script>

</body>
</html>
